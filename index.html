<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <base href="/chatweb/">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0175C2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Faekon Suporte">
  <meta name="flutter-web-renderer" content="html">
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <title>Faekon Suporte</title>

  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "61e6874c-bca0-4628-ad07-8053c0cd499e", // REVISE: Coloque aqui o ID do OneSignal
        safari_web_id: "SEU_SAFARI_ID_AQUI", // Opcional
        serviceWorkerPath: "/chatweb/OneSignalSDK.sw.js",
        notifyButton: {
          enable: true,
          position: 'bottom-right',
          theme: 'default',
          text: {
            'tip.state.unsubscribed': 'Inscreva-se para notificações',
            'tip.state.subscribed': "Você está inscrito",
            'tip.state.blocked': "Você bloqueou as notificações",
            'message.prenotify': 'Clique para receber alertas de novas mensagens',
          }
        },
        allowLocalhostAsSecureOrigin: true,
      });

      // Função auxiliar para limpar o ID (remover aspas extras do SharedPreferences)
      function cleanUserId(id) {
        if (!id) return null;
        if (id.startsWith('"') && id.endsWith('"')) {
          return id.slice(1, -1);
        }
        return id;
      }

      // Função global para forçar login (útil para debug ou chamada externa)
      window.forceOneSignalLogin = async function(rawId) {
        const id = cleanUserId(rawId);
        if (id) {
          console.log("Forçando login OneSignal com ID:", id);
          await OneSignal.login(id);
          console.log("Login efetuado para:", id);
        }
      };

      try {
        await OneSignal.Notifications.requestPermission(true);
        let rawUid = localStorage.getItem('flutter.userId') || localStorage.getItem('userId');
        let uid = cleanUserId(rawUid);
        
        // Verifica se é admin
        const isAdmin = localStorage.getItem('flutter.isAdmin') === 'true' || 
                        localStorage.getItem('flutter.isAdmin') === '"true"';

        if (isAdmin) {
          uid = 'admin';
        }

        if (uid) {
          await OneSignal.login(uid);
          console.log('OneSignal Web: external_id inicial definido para', uid);
        } else {
          console.log('OneSignal Web: aguardando userId...');
        }
        
        // Tenta solicitar subscrição explicitamente
        // Nota: Browsers podem bloquear se não houver interação do usuário, mas o notifyButton ajuda
        try {
          const perm = await OneSignal.Notifications.permission;
          console.log('OneSignal Web: permission=', perm);
          if (perm === 'granted' && OneSignal.User.PushSubscription.optedIn === false) {
            console.log("Solicitando optIn...");
            await OneSignal.User.PushSubscription.optIn();
            console.log("OneSignal Web: optIn solicitado");
          }
          console.log('OneSignal Web: optedIn=', OneSignal.User.PushSubscription.optedIn);
          if (perm === 'granted') {
            if (navigator && navigator.serviceWorker && navigator.serviceWorker.controller) {
              navigator.serviceWorker.controller.postMessage({type:'CLOSE_ALL'});
              console.log('OneSignal Web: solicitada limpeza de notificações via SW');
            }
          }
        } catch (e) {
          console.log('OneSignal Web: erro ao verificar/optar subscrição', e);
        }

        // Listener para mudanças no localStorage (quando o Flutter salva o ID)
        let lastUid = uid;
        setInterval(async () => {
           let currentRaw = localStorage.getItem('flutter.userId') || localStorage.getItem('userId');
           let currentUid = cleanUserId(currentRaw);
           
           const currentIsAdmin = localStorage.getItem('flutter.isAdmin') === 'true' || 
                                  localStorage.getItem('flutter.isAdmin') === '"true"';
           
           if (currentIsAdmin) currentUid = 'admin';

           if (currentUid && currentUid !== lastUid) {
             console.log('OneSignal Web: ID alterado/detectado:', currentUid);
             await OneSignal.login(currentUid);
             lastUid = currentUid;
             
             try {
               const permNow = await OneSignal.Notifications.permission;
               if (permNow === 'granted' && OneSignal.User.PushSubscription.optedIn === false) {
                  await OneSignal.User.PushSubscription.optIn();
                  console.log('OneSignal Web: optIn solicitado após ID atualizado');
               }
               if (permNow === 'granted') {
                 if (navigator && navigator.serviceWorker && navigator.serviceWorker.controller) {
                   navigator.serviceWorker.controller.postMessage({type:'CLOSE_ALL'});
                   console.log('OneSignal Web: solicitada limpeza de notificações via SW (ID atualizado)');
                 }
               }
             } catch {}
           }
        }, 2000); // Verifica a cada 2 segundos

      } catch (e) {
        console.log('OneSignal Web: erro ao configurar', e);
      }
    });
  </script>

  <script src="flutter_bootstrap.js" async></script>
</head>
<body>
  </body>
</html>
