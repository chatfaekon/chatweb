<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <base href="/chatweb/">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0175C2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Faekon Suporte">
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <title>Faekon Suporte</title>

  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "61e6874c-bca0-4628-ad07-8053c0cd499e", // REVISE: Coloque aqui o ID do OneSignal
        safari_web_id: "SEU_SAFARI_ID_AQUI", // Opcional
        notifyButton: {
          enable: true,
          position: 'bottom-right',
          theme: 'default',
          text: {
            'tip.state.unsubscribed': 'Inscreva-se para notificações',
            'tip.state.subscribed': "Você está inscrito",
            'tip.state.blocked': "Você bloqueou as notificações",
            'message.prenotify': 'Clique para receber alertas de novas mensagens',
          }
        },
        allowLocalhostAsSecureOrigin: true,
      });

      try {
        await OneSignal.Notifications.requestPermission(true);
        const isAdmin =
          localStorage.getItem('flutter.isAdmin') === 'true' ||
          localStorage.getItem('isAdmin') === 'true';
        const uidRaw =
          localStorage.getItem('flutter.userId') ||
          localStorage.getItem('userId');
        const uid = isAdmin ? 'admin' : uidRaw;
        if (uid) {
          await OneSignal.login(uid);
          window.__onesignalExternalIdSet = true;
          console.log('OneSignal Web: external_id definido para', uid);
        } else {
          console.log('OneSignal Web: nenhum userId encontrado em localStorage');
        }
        try {
          const perm = await OneSignal.Notifications.permission;
          console.log('OneSignal Web: permission', perm);
          if (perm === 'granted' && !OneSignal.User.pushSubscription.optedIn) {
            await OneSignal.User.pushSubscription.optIn();
            console.log('OneSignal Web: pushSubscription optIn acionado');
          }
          console.log('OneSignal Web: optedIn', OneSignal.User.pushSubscription.optedIn);
        } catch (err) {
          console.log('OneSignal Web: erro ao optar pela subscrição', err);
        }
        window.__onesignalPollAttempts = 0;
        window.__onesignalPollTimer = setInterval(async function() {
          try {
            const isAdm =
              localStorage.getItem('flutter.isAdmin') === 'true' ||
              localStorage.getItem('isAdmin') === 'true';
            const raw =
              localStorage.getItem('flutter.userId') ||
              localStorage.getItem('userId');
            const id = isAdm ? 'admin' : raw;
            if (id && !window.__onesignalExternalIdSet) {
              await OneSignal.login(id);
              window.__onesignalExternalIdSet = true;
              console.log('OneSignal Web: external_id atualizado via polling para', id);
              clearInterval(window.__onesignalPollTimer);
            }
            try {
              const permNow = await OneSignal.Notifications.permission;
              if (permNow === 'granted' && !OneSignal.User.pushSubscription.optedIn) {
                await OneSignal.User.pushSubscription.optIn();
                console.log('OneSignal Web: pushSubscription optIn acionado via polling');
              }
            } catch {}
            window.__onesignalPollAttempts++;
            if (window.__onesignalPollAttempts > 60) {
              clearInterval(window.__onesignalPollTimer);
            }
          } catch (err) {
            console.log('OneSignal Web: erro no polling de external_id', err);
            window.__onesignalPollAttempts++;
            if (window.__onesignalPollAttempts > 60) {
              clearInterval(window.__onesignalPollTimer);
            }
          }
        }, 1000);
      } catch (e) {
        console.log('OneSignal Web: erro ao definir external_id', e);
      }
    });
  </script>

  <script src="flutter_bootstrap.js" async></script>
</head>
<body>
  </body>
</html>
